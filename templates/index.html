<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Analyzer</title>

    <style>
        body {
            margin: 0;
            font-family: "Poppins", sans-serif;
            background: linear-gradient(135deg, #4e73df, #1cc7d0);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #fff;
        }
        .container {
            width: 400px;
            padding: 30px;
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            text-align: center;
        }
        .upload-box {
            border: 2px dashed #fff;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
        }
        .upload-box:hover {
            background: rgba(255,255,255,0.2);
        }
        .btn {
            margin-top: 20px;
            padding: 12px;
            width: 100%;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            background: #1cc7d0;
            color: #fff;
        }
        .result-card {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            text-align: left;
        }
        .preview-img {
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
        }
        .loader {
            margin: 20px auto;
            border: 6px solid #fff;
            border-top: 6px solid transparent;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .hidden { display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üíä Medicine Analyzer</h1>

    <div class="upload-box" id="uploadBox">
        <p>üì∏ Drag & Drop Image OR Click to Upload</p>
        <input type="file" id="fileInput" accept="image/*" hidden>
    </div>

    <button id="analyzeBtn" class="btn">Analyze Medicine</button>

    <div id="loader" class="loader hidden"></div>

    <div id="result" class="result-card hidden">
        <h2>Result</h2>
        <p><strong>Medicine:</strong> <span id="medName"></span></p>
        <p><strong>Similarity Score:</strong> <span id="score"></span></p>

        <div id="extraDetails"></div>

        <button id="speakBtn" class="btn" style="background:#ff9800;">
            üîä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•Å‡§®‡•á‡§Ç
        </button>

        <img id="previewImg" class="preview-img" />
    </div>
</div>

<script>
    const GROQ_KEY = "{{ groq_key }}";
</script>

<script>
let selectedFile = null;

const uploadBox = document.getElementById("uploadBox");
const fileInput = document.getElementById("fileInput");

uploadBox.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", e => {
    selectedFile = e.target.files[0];
    uploadBox.innerHTML = `<p>üìÑ ${selectedFile.name}</p>`;
});


// ===============================
// Analyze Image
// ===============================
document.getElementById("analyzeBtn").addEventListener("click", async () => {
    if (!selectedFile) return alert("Upload an image first!");

    document.getElementById("loader").classList.remove("hidden");

    const formData = new FormData();
    formData.append("file", selectedFile);

    const res = await fetch("/analyze", { method: "POST", body: formData });
    const data = await res.json();

    window.currentDetails = data.details;

    document.getElementById("loader").classList.add("hidden");
    document.getElementById("result").classList.remove("hidden");

    document.getElementById("medName").textContent = data.results[0].label;
    document.getElementById("score").textContent = data.results[0].score.toFixed(4);

    document.getElementById("extraDetails").innerHTML = `
        <p><strong>Composition:</strong> ${data.details.Composition}</p>
        <p><strong>Uses:</strong> ${data.details.Uses}</p>
        <p><strong>Side Effects:</strong> ${data.details.Side_effects}</p>
        <p><strong>Manufacturer:</strong> ${data.details.Manufacturer}</p>
    `;

    document.getElementById("previewImg").src = URL.createObjectURL(selectedFile);
});


// ===============================
// GENERATE SHORT NATURAL HINDI EXPLANATION
// ===============================
async function generateHindiExplanation(details) {

    const englishText = `
    Medicine Name: ${details["Medicine Name"]}.
    Composition: ${details["Composition"]}.
    Uses: ${details["Uses"]}.
    Side Effects: ${details["Side_effects"]}.
    Manufacturer: ${details["Manufacturer"]}.
    `;

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + GROQ_KEY,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "llama-3.3-70b-versatile",
            messages: [
                {
                    role: "system",
                    content:
                    "Translate all information into PURE HINDI ONLY. Write exactly 4‚Äì5 full sentences in ONE paragraph. NO bullet points, NO bold text, NO lists, NO English words, NO markdown, NO newlines. The paragraph must be very smooth for text-to-speech. Use simple spoken Hindi suitable for patients."
                },
                {
                    role: "user",
                    content: englishText
                }
            ]
        })
    });

    const json = await response.json();
    console.log("GROQ RAW:", json);

    if (json.error) {
        return "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§";
    }

    let hindi = json.choices[0].message.content;

    // cleanup for TTS
    hindi = hindi.replace(/\*/g, "");
    hindi = hindi.replace(/[-‚Ä¢‚óè]/g, " ");
    hindi = hindi.replace(/\n/g, " ");
    hindi = hindi.replace(/\s\s+/g, " ");

    return hindi.trim();
}


// ===============================
// HINDI SPEAK FUNCTION
// ===============================
speechSynthesis.getVoices();
speechSynthesis.onvoiceschanged = () => {
    console.log("Voices Ready");
};

function speakHindi(text) {
    if (!text || text.trim() === "") {
        alert("Hindi explanation failed");
        return;
    }

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "hi-IN";
    u.rate = 0.95;
    u.pitch = 1;

    const voices = speechSynthesis.getVoices();
    const hindiVoice = voices.find(v => v.lang.includes("hi"));

    if (hindiVoice) u.voice = hindiVoice;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
}


// ===============================
// SPEAK BUTTON ‚Üí Generate + Speak
// ===============================
document.getElementById("speakBtn").addEventListener("click", async () => {
    const det = window.currentDetails;
    const hindiText = await generateHindiExplanation(det);

    console.log("Hindi Explanation:", hindiText);

    speakHindi(hindiText);
});
</script>

</body>
</html>
